<?php
//INCLUDE DATABASE FILE
include('database.php');
session_start();


if(isset($_POST['signUp']))     signup();
if(isset($_POST['login']))      login();
if(isset($_POST['addBook']))    addBooks();
if(isset($_GET['id']))          delete();
if(isset($_POST['update']))     update();
if(isset($_POST['editProfi']))  editProfil();


//================================================================================================================================================================================//
//================================================================================= SING UP FUNCTION =============================================================================//
//================================================================================================================================================================================//

function signup(){
    global $conn;
    $Name = $_POST['name'];
    $Email = $_POST['email'];
    $Password = $_POST['password'];
    $sql="SELECT count(*) FROM admins where email= '$Email'";
    $result=mysqli_query($conn,$sql);
    $row = mysqli_fetch_assoc($result);
   if($row['count(*)'] == 1){
    header('location: signup.php');
    $_SESSION['already']="email already exist!";
   }else{
       $request="INSERT INTO admins VALUES(null,'$Name','$Email','$Password');";
       mysqli_query($conn,$request);
       header('location: login.php');
   }
}
//================================================================================================================================================================================//
//================================================================================= LOGIN FUNCTION ===============================================================================//
//================================================================================================================================================================================//

function login(){
    global $conn;
    
    $Email = $_POST['email'];
    $Password = $_POST['password'];
    $request="SELECT * FROM admins WHERE email='$Email' AND password='$Password' " ;
    $result=mysqli_query($conn,$request);
    if(mysqli_num_rows($result)==1){
        $owner=mysqli_fetch_assoc($result);
        $_SESSION["id"]=$owner['id'];
        header('location: dashboard.php');
    }else{
        header('location: login.php');
        $_SESSION['message']="enter a valid data";
    }
}

//================================================================================================================================================================================//
//================================================================================= ADD BOOKS FUNCTION ===========================================================================//
//================================================================================================================================================================================//

function addBooks(){
    global $conn;
    $Title=$_POST['title'];
    $Author=$_POST['author'];
    $Price=$_POST['price'];
    $request="INSERT INTO books VALUE(null,'$Title','$Author','$Price')";
    mysqli_query($conn,$request);
    header('location:dashboard.php');
} 

//================================================================================================================================================================================//
//================================================================================= DISPLAY FUNCTION =============================================================================//
//================================================================================================================================================================================//

function displayBooks(){
    global $conn;
    $request="SELECT * FROM books ";
    $result=mysqli_query($conn,$request);
    while($row=mysqli_fetch_assoc($result)){
        $id=$row['id'];
        echo'
        <tr id="'.$id.'">
            <td>'.$row['id'].'</td>
            <td class="book-title">'.$row['title'].'</td>
            <td class="book-author">'.$row['author'].'</td>
            <td class="book-price">'.$row['price'].'</td>
            <td class="text-center d-flex">
            <a class="text-decoration-none bg-danger border-0 rounded px-2 py-1 text-dark" href="dashboard.php?id='.$id.'">DELETE</a>
            <button class="bg-success border-0 rounded px-2 py-1 ms-2" data-bs-toggle="modal" data-bs-target="#addModal"  onclick="popUp('.$id.')">UPDATE</button>
            </td>
        </tr>
        ';
    }
}

//================================================================================================================================================================================//
//================================================================================= DELETE FUNCTION =============================================================================//
//================================================================================================================================================================================//

function delete(){
    global $conn;
    $id=$_GET['id'];
    $Delete="DELETE FROM books WHERE id=$id";
    mysqli_query($conn,$Delete);
}

//================================================================================================================================================================================//
//=================================================================================BOOK COUNTER FUNCTION =============================================================================//
//================================================================================================================================================================================//

function bookCounter(){
    global $conn;
    $request="SELECT * FROM books";
    if ($result=mysqli_query($conn,$request)){
    $rowcount=mysqli_num_rows($result);
    echo $rowcount;
    }
}

//================================================================================================================================================================================//
//=================================================================================TOTAL PRICE FUNCTION =============================================================================//
//================================================================================================================================================================================//

function totalPrice(){
    global $conn;
    $request="SELECT sum(price) FROM `books`";
    $result=mysqli_query($conn,$request);
    if($result){
        $totalprice=mysqli_fetch_assoc($result);
        echo $totalprice['sum(price)'];
    }
}
//================================================================================================================================================================================//
//=================================================================================UPDATE FUNCTION =============================================================================//
//================================================================================================================================================================================//

function update(){
    global $conn;
    $id=$_POST['id'];
    $Title=$_POST['title'];
    $Author=$_POST['author'];
    $Price=$_POST['price'];
    $request="UPDATE `books` SET `title`='$Title',`author`='$Author',`price`=$Price WHERE  id = $id";
    mysqli_query($conn,$request);
    header('location:dashboard.php');
}


//================================================================================================================================================================================//
//=================================================================================EDIT PROFILE FUNCTION =============================================================================//
//================================================================================================================================================================================//

function editProfil(){
    global $conn;
    $id=$_POST['idInput'];
    $name=$_POST['nameInput'];
    $email=$_POST['emailInput'];
    $password=$_POST['passwordInput'];
    $request="UPDATE `admins` SET `name`='$name',`email`='$email',`password`='$password' WHERE id=$id";
    mysqli_query($conn,$request);
    header('location:dashboard.php');
}
